"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;
var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));
var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));
var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));
var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));
var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));
var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));
var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));
var _react = _interopRequireDefault(require("react"));
var _propTypes = _interopRequireDefault(require("prop-types"));
var _UUID = _interopRequireDefault(require("./UUID"));
function ownKeys(e, r) { var t = Object.keys(e); if (Object.getOwnPropertySymbols) { var o = Object.getOwnPropertySymbols(e); r && (o = o.filter(function (r) { return Object.getOwnPropertyDescriptor(e, r).enumerable; })), t.push.apply(t, o); } return t; }
function _objectSpread(e) { for (var r = 1; r < arguments.length; r++) { var t = null != arguments[r] ? arguments[r] : {}; r % 2 ? ownKeys(Object(t), !0).forEach(function (r) { (0, _defineProperty2["default"])(e, r, t[r]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(t)) : ownKeys(Object(t)).forEach(function (r) { Object.defineProperty(e, r, Object.getOwnPropertyDescriptor(t, r)); }); } return e; }
function _callSuper(t, o, e) { return o = (0, _getPrototypeOf2["default"])(o), (0, _possibleConstructorReturn2["default"])(t, _isNativeReflectConstruct() ? Reflect.construct(o, e || [], (0, _getPrototypeOf2["default"])(t).constructor) : o.apply(t, e)); }
function _isNativeReflectConstruct() { try { var t = !Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); } catch (t) {} return (_isNativeReflectConstruct = function _isNativeReflectConstruct() { return !!t; })(); } /**
 * <DynamicOptionList />
 */
var DynamicOptionList = exports["default"] = /*#__PURE__*/function (_React$Component) {
  function DynamicOptionList(props) {
    var _this;
    (0, _classCallCheck2["default"])(this, DynamicOptionList);
    _this = _callSuper(this, DynamicOptionList, [props]);
    // Throttle utility function
    (0, _defineProperty2["default"])(_this, "throttle", function (func, wait) {
      return function () {
        for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
          args[_key] = arguments[_key];
        }
        var now = Date.now();
        var remaining = wait - (now - _this.previousTime);
        if (remaining <= 0 || remaining > wait) {
          if (_this.timeoutId) {
            clearTimeout(_this.timeoutId);
          }
          _this.previousTime = now;
          func.apply(_this, args);
        } else if (!_this.timeoutId) {
          _this.timeoutId = setTimeout(function () {
            _this.previousTime = now;
            _this.timeoutId = null;
            func.apply(_this, args);
          }, remaining);
        }
      };
    });
    (0, _defineProperty2["default"])(_this, "setValue", function (text) {
      return text.replace(/[^A-Z0-9]+/gi, '_').toLowerCase();
    });
    (0, _defineProperty2["default"])(_this, "handleOptionChange", _this.throttle(function (optionIndex, _ref) {
      var value = _ref.target.value;
      var element = _this.state.element;
      var newElement = _objectSpread({}, element);
      var currentOption = newElement.options[optionIndex];
      var autoGeneratedValue = _this.setValue(currentOption.text);
      var shouldAutoGenerate = !currentOption.value || currentOption.value === autoGeneratedValue;
      var val = shouldAutoGenerate ? _this.setValue(value) : currentOption.value;
      newElement.options[optionIndex].text = value;
      newElement.options[optionIndex].value = val;
      _this.setState({
        element: newElement,
        dirty: true
      }, function () {
        _this.syncOptionsWithSameColumnElements(newElement.options);
      });
    }, 200));
    (0, _defineProperty2["default"])(_this, "handleValueChange", _this.throttle(function (optionIndex, _ref2) {
      var value = _ref2.target.value;
      var element = _this.state.element;
      var newElement = _objectSpread({}, element);
      newElement.options[optionIndex].value = value;
      _this.setState({
        element: newElement,
        dirty: true
      }, function () {
        _this.syncOptionsWithSameColumnElements(newElement.options);
      });
    }, 200));
    (0, _defineProperty2["default"])(_this, "handleOptionCorrect", function (optionIndex) {
      _this.setState(function (prevState) {
        var newElement = _objectSpread({}, prevState.element);
        var option = newElement.options[optionIndex];
        if (Object.prototype.hasOwnProperty.call(option, 'correct')) {
          delete option.correct;
        } else {
          option.correct = true;
        }
        return {
          element: newElement
        };
      }, function () {
        var _this$props = _this.props,
          updateElement = _this$props.updateElement,
          preview = _this$props.preview;
        var element = _this.state.element;
        updateElement.call(preview, element);
        _this.syncOptionsWithSameColumnElements(element.options);
      });
    });
    (0, _defineProperty2["default"])(_this, "handleOptionInfo", function (optionIndex) {
      _this.setState(function (prevState) {
        var newElement = _objectSpread({}, prevState.element);
        var option = newElement.options[optionIndex];
        if (Object.prototype.hasOwnProperty.call(option, 'info')) {
          delete option.info;
        } else {
          option.info = true;
        }
        return {
          element: newElement
        };
      }, function () {
        var _this$props2 = _this.props,
          updateElement = _this$props2.updateElement,
          preview = _this$props2.preview;
        var element = _this.state.element;
        updateElement.call(preview, element);
        _this.syncOptionsWithSameColumnElements(element.options);
      });
    });
    (0, _defineProperty2["default"])(_this, "updateOption", function () {
      var _this$props3 = _this.props,
        updateElement = _this$props3.updateElement,
        preview = _this$props3.preview;
      var _this$state = _this.state,
        element = _this$state.element,
        dirty = _this$state.dirty;
      if (dirty) {
        updateElement.call(preview, element);
        _this.setState({
          dirty: false
        }, function () {
          _this.syncOptionsWithSameColumnElements(element.options);
        });
      }
    });
    (0, _defineProperty2["default"])(_this, "addOption", function (index) {
      _this.setState(function (prevState) {
        var newElement = _objectSpread({}, prevState.element);
        var nextValue = Math.max.apply(Math, (0, _toConsumableArray2["default"])(newElement.options.map(function (_ref3) {
          var value = _ref3.value;
          return Number.isNaN(Number(value)) ? 0 : parseInt(value, 10);
        }))) + 1;
        newElement.options.splice(index + 1, 0, {
          value: nextValue,
          text: '',
          key: _UUID["default"].uuid()
        });
        return {
          element: newElement,
          dirty: true
        };
      }, function () {
        var element = _this.state.element;
        _this.syncOptionsWithSameColumnElements(element.options);
      });
    });
    (0, _defineProperty2["default"])(_this, "removeOption", function (index) {
      _this.setState(function (prevState) {
        var newElement = _objectSpread({}, prevState.element);
        newElement.options.splice(index, 1);
        return {
          element: newElement,
          dirty: true
        };
      }, function () {
        var element = _this.state.element;
        _this.syncOptionsWithSameColumnElements(element.options);
      });
    });
    (0, _defineProperty2["default"])(_this, "syncOptionsWithSameColumnElements", function (options) {
      var _preview$state, _parentElement$column;
      var _this$props4 = _this.props,
        preview = _this$props4.preview,
        propsElement = _this$props4.element,
        propsUpdateElement = _this$props4.updateElement;
      if (!preview || !propsElement.parentId) {
        return;
      }
      var parentElement;
      var getDataById = preview.getDataById || ((_preview$state = preview.state) === null || _preview$state === void 0 ? void 0 : _preview$state.data) && function (id) {
        return preview.state.data.find(function (x) {
          return x.id === id;
        });
      };
      var columnIndex = propsElement.col,
        currentRowIndex = propsElement.row;
      if (columnIndex === undefined || currentRowIndex === undefined) {
        return;
      }
      if (typeof getDataById === 'function') {
        parentElement = getDataById(propsElement.parentId);
      }
      if (!parentElement || !parentElement.childItems || parentElement.element !== 'DynamicColumnRow' || ((_parentElement$column = parentElement.columns) === null || _parentElement$column === void 0 ? void 0 : _parentElement$column[columnIndex].isSync) === false) {
        return;
      }
      var updateElement = typeof preview.updateElement === 'function' ? preview.updateElement : propsUpdateElement;
      if (!updateElement) {
        return;
      }
      parentElement.childItems.forEach(function (row, rowIndex) {
        if (rowIndex === currentRowIndex) return;
        var elementId = row[columnIndex];
        if (!elementId) return;
        var elementData = getDataById(elementId);
        if (!elementData || elementData.element !== propsElement.element || !Array.isArray(elementData.options)) {
          return;
        }
        var newOptions = options.map(function (option, i) {
          var _option$info, _option$correct;
          if (i >= elementData.options.length) {
            return _objectSpread(_objectSpread({}, option), {}, {
              key: _UUID["default"].uuid()
            });
          }
          var key = elementData.options[i].key;
          return _objectSpread(_objectSpread({}, option), {}, {
            key: key || _UUID["default"].uuid(),
            info: (_option$info = option.info) !== null && _option$info !== void 0 ? _option$info : false,
            correct: (_option$correct = option.correct) !== null && _option$correct !== void 0 ? _option$correct : false
          });
        });
        var updatedElement = _objectSpread(_objectSpread({}, elementData), {}, {
          options: newOptions,
          dirty: true
        });
        updateElement(updatedElement);
      });
    });
    _this.state = {
      element: _this.props.element,
      data: _this.props.data,
      dirty: false
    };
    _this.previousTime = 0;
    _this.timeoutId = null;
    return _this;
  }
  (0, _inherits2["default"])(DynamicOptionList, _React$Component);
  return (0, _createClass2["default"])(DynamicOptionList, [{
    key: "componentWillUnmount",
    value:
    // Clean up any pending timeouts
    function componentWillUnmount() {
      if (this.timeoutId) {
        clearTimeout(this.timeoutId);
      }
    }
  }, {
    key: "render",
    value: function render() {
      var _this2 = this;
      var _this$state2 = this.state,
        element = _this$state2.element,
        dirty = _this$state2.dirty;
      var _this$props5 = this.props,
        canHaveOptionValue = _this$props5.canHaveOptionValue,
        canHaveInfo = _this$props5.canHaveInfo,
        canHaveOptionCorrect = _this$props5.canHaveOptionCorrect,
        propsElement = _this$props5.element;
      var isInDynamicColumn = !!(propsElement !== null && propsElement !== void 0 && propsElement.parentId && (propsElement === null || propsElement === void 0 ? void 0 : propsElement.col) !== undefined && (propsElement === null || propsElement === void 0 ? void 0 : propsElement.row) !== undefined);
      var shouldShowInfo = canHaveInfo || isInDynamicColumn && (propsElement === null || propsElement === void 0 ? void 0 : propsElement.element) === 'Checkboxes';
      var shouldShowCorrect = canHaveOptionCorrect || isInDynamicColumn && (propsElement === null || propsElement === void 0 ? void 0 : propsElement.element) === 'Checkboxes';
      return /*#__PURE__*/_react["default"].createElement("div", {
        className: "dynamic-option-list"
      }, /*#__PURE__*/_react["default"].createElement("ul", null, /*#__PURE__*/_react["default"].createElement("li", null, /*#__PURE__*/_react["default"].createElement("div", {
        className: "row"
      }, /*#__PURE__*/_react["default"].createElement("div", {
        className: "col-sm-5"
      }, /*#__PURE__*/_react["default"].createElement("b", null, "Options")), canHaveOptionValue && /*#__PURE__*/_react["default"].createElement("div", {
        className: "col-sm-2"
      }, /*#__PURE__*/_react["default"].createElement("b", null, "Value")), shouldShowInfo && /*#__PURE__*/_react["default"].createElement("div", {
        className: "col-sm-1"
      }, /*#__PURE__*/_react["default"].createElement("b", null, "Info")), shouldShowCorrect && /*#__PURE__*/_react["default"].createElement("div", {
        className: "col-sm-1"
      }, /*#__PURE__*/_react["default"].createElement("b", null, "Correct")))), element.options.map(function (option, index) {
        var itemKey = "edit_".concat(option.key);
        var val = option.value || '';
        return /*#__PURE__*/_react["default"].createElement("li", {
          className: "clearfix",
          key: itemKey
        }, /*#__PURE__*/_react["default"].createElement("div", {
          className: "row"
        }, /*#__PURE__*/_react["default"].createElement("div", {
          className: "col-sm-5"
        }, /*#__PURE__*/_react["default"].createElement("input", {
          type: "text",
          className: "form-control",
          style: {
            width: '100%'
          },
          value: option.text,
          onChange: function onChange(e) {
            var element = _this2.state.element;
            var newElement = _objectSpread({}, element);
            newElement.options[index].text = e.target.value;
            _this2.setState({
              element: newElement,
              dirty: true
            });
            _this2.handleOptionChange(index, e);
          },
          onBlur: _this2.updateOption
        })), canHaveOptionValue && /*#__PURE__*/_react["default"].createElement("div", {
          className: "col-sm-2"
        }, /*#__PURE__*/_react["default"].createElement("input", {
          type: "text",
          className: "form-control",
          style: {
            width: '100%'
          },
          value: val,
          onChange: function onChange(e) {
            return _this2.handleValueChange(index, e);
          },
          onBlur: _this2.updateOption
        })), canHaveOptionValue && canHaveInfo && /*#__PURE__*/_react["default"].createElement("div", {
          className: "col-sm-1"
        }, /*#__PURE__*/_react["default"].createElement("input", {
          className: "form-control",
          type: "checkbox",
          value: "1",
          checked: Object.prototype.hasOwnProperty.call(option, 'info') && option.info,
          onChange: function onChange() {
            return _this2.handleOptionInfo(index);
          }
        })), canHaveOptionValue && canHaveOptionCorrect && /*#__PURE__*/_react["default"].createElement("div", {
          className: "col-sm-1"
        }, /*#__PURE__*/_react["default"].createElement("input", {
          className: "form-control",
          type: "checkbox",
          value: "1",
          checked: Object.prototype.hasOwnProperty.call(option, 'correct') && option.correct,
          onChange: function onChange() {
            return _this2.handleOptionCorrect(index);
          }
        })), /*#__PURE__*/_react["default"].createElement("div", {
          className: "col-sm-3"
        }, /*#__PURE__*/_react["default"].createElement("div", {
          className: "dynamic-options-actions-buttons"
        }, /*#__PURE__*/_react["default"].createElement("button", {
          onClick: function onClick() {
            return _this2.addOption(index);
          },
          type: "button",
          className: "btn btn-success"
        }, /*#__PURE__*/_react["default"].createElement("i", {
          className: "fas fa-plus-circle"
        })), index > 0 && /*#__PURE__*/_react["default"].createElement("button", {
          onClick: function onClick() {
            return _this2.removeOption(index);
          },
          type: "button",
          className: "btn btn-danger"
        }, /*#__PURE__*/_react["default"].createElement("i", {
          className: "fas fa-minus-circle"
        }))))));
      })), dirty && (element.dirty = true));
    }
  }]);
}(_react["default"].Component);
(0, _defineProperty2["default"])(DynamicOptionList, "propTypes", {
  element: _propTypes["default"].shape({
    options: _propTypes["default"].arrayOf(_propTypes["default"].shape({
      text: _propTypes["default"].string,
      value: _propTypes["default"].oneOfType([_propTypes["default"].string, _propTypes["default"].number]),
      key: _propTypes["default"].string
    })).isRequired,
    parentId: _propTypes["default"].string,
    col: _propTypes["default"].number,
    row: _propTypes["default"].number,
    element: _propTypes["default"].string
  }).isRequired,
  data: _propTypes["default"].shape({}),
  updateElement: _propTypes["default"].func,
  preview: _propTypes["default"].shape({
    state: _propTypes["default"].shape({
      data: _propTypes["default"].arrayOf(_propTypes["default"].shape({
        id: _propTypes["default"].string.isRequired
      }))
    }),
    getDataById: _propTypes["default"].func,
    updateElement: _propTypes["default"].func
  }),
  canHaveOptionValue: _propTypes["default"].bool,
  canHaveOptionCorrect: _propTypes["default"].bool,
  canHaveInfo: _propTypes["default"].bool
});
(0, _defineProperty2["default"])(DynamicOptionList, "defaultProps", {
  data: {},
  updateElement: function updateElement() {},
  preview: null,
  canHaveOptionValue: false,
  canHaveOptionCorrect: false,
  canHaveInfo: false
});